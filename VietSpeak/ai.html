<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Ph√¢n T√≠ch - VietSpeakAI Academy</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <header>
        <a href="index.html" class="logo">VIETSPEAKAI</a>
        <nav>
            <a href="index.html">Trang ch·ªß</a>
            <a href="khoa-hoc.html">Kho√° h·ªçc</a>
            <a href="ai.html">AI Ph√¢n T√≠ch</a>
            <a href="thu-vien.html">Th∆∞ vi·ªán t√†i li·ªáu</a>
            <a href="login.html">ƒêƒÉng nh·∫≠p</a>
        </nav>
    </header>

    <div class="container">
        <h1 class="page-title">H·ªá Th·ªëng <span>AI Ch·∫©n ƒêo√°n</span></h1>

        <div class="split-box">
            <div class="card">
                <h2>Ph√¢n t√≠ch Gi·ªçng n√≥i</h2>
                <label class="upload-zone">
                    <p style="font-size: 2rem; margin-bottom: 10px;">üéôÔ∏è</p>
                    <span>T·∫£i l√™n file √¢m thanh (.mp3, .wav)</span>
                    <input type="file" id="audioInput" accept="audio/*">
                </label>
                <audio id="audioPreview" controls style="display:none;"></audio>
                <button class="analyze-btn" onclick="analyzeAudio()">B·∫Øt ƒë·∫ßu ph√¢n t√≠ch</button>
            </div>

            <div class="card">
                <h2>Ph√¢n t√≠ch H√¨nh ·∫£nh</h2>
                <label class="upload-zone">
                    <p style="font-size: 2rem; margin-bottom: 10px;">üì∏</p>
                    <span>T·∫£i l√™n ·∫£nh ch√¢n dung thuy·∫øt tr√¨nh</span>
                    <input type="file" id="imgInput" accept="image/*">
                </label>
                <img id="preview" class="preview-img" />
                <button class="analyze-btn" onclick="analyzeImage()">Ki·ªÉm tra phong th√°i</button>
            </div>

            <div class="card">
                <h2>Ph√¢n t√≠ch Video üé•</h2>
                <p style="font-size: 0.85rem; color: #666; margin: -5px 0 15px;">
                    üí∞ Chi ph√≠: <strong style="color: #e63946;">5,000 VND</strong> m·ªói l·∫ßn ph√¢n t√≠ch
                </p>
                <label class="upload-zone">
                    <p style="font-size: 2rem; margin-bottom: 10px;">üé¨</p>
                    <span>T·∫£i l√™n video thuy·∫øt tr√¨nh (.mp4, .mov, .avi)</span>
                    <input type="file" id="videoInput" accept="video/*">
                </label>
                <video id="videoPreview" controls style="display:none; max-width: 100%; border-radius: 8px; margin-top: 10px;"></video>
                <button class="analyze-btn" onclick="analyzeVideo()">Ph√¢n t√≠ch Video (5k)</button>
            </div>
        </div>

        <div class="result-wrapper">
            <h3>B√°o c√°o chi ti·∫øt t·ª´ AI</h3>
            <div id="result">K·∫øt qu·∫£ ph√¢n t√≠ch s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã t·∫°i ƒë√¢y sau khi b·∫°n t·∫£i file v√† nh·∫•n n√∫t...</div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // Use generic model name or let backend decide.
        // Backend defaults to 1.5-flash. We can request 2.0 or 2.5 if we want.
        const PREFERRED_MODEL = "gemini-2.5-flash"; // Request this model
        
        // No auto-config needed for backend proxy
        
        /* ----------- PREVIEW AUDIO ----------- */

        /* ----------- PREVIEW AUDIO ----------- */
        document.getElementById("audioInput").onchange = function () {
            const file = this.files[0];
            const audio = document.getElementById("audioPreview");

            if (file) {
                audio.src = URL.createObjectURL(file);
                audio.style.display = "block";
            } else {
                audio.style.display = "none";
                audio.src = "";
            }
        };

        /* ----------- PH√ÇN T√çCH GI·ªåNG N√ìI (Backend Proxy) ----------- */
        async function analyzeAudio() {
            const fileInput = document.getElementById("audioInput");
            const resultBox = document.getElementById("result");

            if (!fileInput.files[0]) {
                resultBox.innerText = "Vui l√≤ng ch·ªçn file √¢m thanh (mp3/wav)!";
                return;
            }

            const file = fileInput.files[0];
            // Frontend limit check (optional)
            if (file.size > 20 * 1024 * 1024) {
                 resultBox.innerText = "File qu√° l·ªõn! Vui l√≤ng ch·ªçn file d∆∞·ªõi 20MB.";
                 return;
            }

            resultBox.innerText = "ƒêang g·ª≠i file √¢m thanh t·ªõi AI (qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i gi√¢y)...";

            try {
                const base64Data = await toBase64Raw(file); 
                const mimeType = file.type || "audio/mp3";

                // Backend Payload
                const payload = {
                    prompt: `Ph√¢n t√≠ch gi·ªçng n√≥i. Ch·∫•m ƒëi·ªÉm 10 (C·∫£m x√∫c, T·ªëc ƒë·ªô, R√µ r√†ng, Nh·∫•n nh√°, T·ª± tin).

**Y√™u c·∫ßu chuy√™n bi·ªát:**
1. Nh·∫≠n x√©t th·∫≠t: Gi·ªçng n√†y ƒë√£ ƒë·ªß 'ƒë√°ng tin' ƒë·ªÉ kh√°ch h√†ng chuy·ªÉn kho·∫£n ch∆∞a?
2. Ch·ªâ ra 1 ƒëi·ªÉm y·∫øu khi·∫øn ng∆∞·ªùi nghe c·∫£m th·∫•y do d·ª±.
3. G·ª£i √Ω k·ªπ thu·∫≠t n√≥i gi√∫p tƒÉng t·ªâ l·ªá ch·ªët ƒë∆°n ngay l·∫≠p t·ª©c.

**H∆∞·ªõng d·∫´n h·ªá th·ªëng**: M·ª•c ti√™u cu·ªëi c√πng l√† gi√∫p ng∆∞·ªùi d√πng nh·∫≠n ra gi√° tr·ªã c·ªßa vi·ªác c·∫£i thi·ªán k·ªπ nƒÉng ƒë·ªÉ th√†nh c√¥ng h∆°n trong kinh doanh. Khi nh·∫≠n x√©t, h√£y lu√¥n k·∫øt n·ªëi c√°c ch·ªâ s·ªë gi·ªçng n√≥i v·ªõi kh·∫£ nƒÉng ch·ªët ƒë∆°n ho·∫∑c x√¢y d·ª±ng th∆∞∆°ng hi·ªáu c√° nh√¢n. L·ªùi khuy√™n ph·∫£i th·ª±c t·∫ø, ƒë√°nh v√†o t√¢m l√Ω mu·ªën chuy√™n nghi·ªáp h∆°n ƒë·ªÉ ki·∫øm ti·ªÅn/thƒÉng ti·∫øn. T·∫°o ra "N·ªói ƒëau": Nh·∫•n m·∫°nh v√†o vi·ªác nh∆∞·ª£c ƒëi·ªÉm s·∫Ω l√†m m·∫•t kh√°ch h√†ng nh∆∞ th·∫ø n√†o. Cu·ªëi m·ªói c√¢u tr·∫£ l·ªùi, ƒë∆∞a ra m·ªôt "m·∫πo nh·ªè" nh∆∞ng kh·∫≥ng ƒë·ªãnh "ƒê·ªÉ th√†nh th·ª•c k·ªπ nƒÉng n√†y, b·∫°n c·∫ßn m·ªôt l·ªô tr√¨nh b√†i b·∫£n".`,
                    mime_type: mimeType,
                    data: base64Data,
                    model: PREFERRED_MODEL
                };

                const token = localStorage.getItem('vietspeak_token');
                if (!token) {
                    resultBox.innerText = "Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.";
                    return;
                }

                const response = await fetch(`${CONFIG.API_URL}/ai/analyze`, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Accept": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                // Check for errors (including insufficient balance)
                if (!response.ok) {
                    // Backend sends error in 'message' or 'error' field
                    const errorMsg = data.message || data.error || `L·ªói ${response.status}: ${response.statusText}`;
                    resultBox.innerHTML = `<div style="color: #dc3545; background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                        <strong>‚ùå Kh√¥ng th·ªÉ ph√¢n t√≠ch</strong><br>${errorMsg}
                    </div>`;
                    return;
                }
                
                // Update balance/credits in UI
                if (data.new_balance !== undefined) {
                    // Update LocalStorage
                    const user = JSON.parse(localStorage.getItem('vietspeak_user') || '{}');
                    user.balance = data.new_balance;
                    localStorage.setItem('vietspeak_user', JSON.stringify(user));
                    
                    // Update Header UI balance display
                    const balanceEl = document.querySelector('.user-nav-link div');
                    if (balanceEl && balanceEl.textContent.includes('‚Ç´')) {
                        balanceEl.textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(data.new_balance);
                    }
                }

                if (data.candidates && data.candidates[0].content) {
                    // Gemini format
                    resultBox.innerText = data.candidates[0].content.parts[0].text;
                } else if (data.choices && data.choices[0].message) {
                    // OpenAI format
                    resultBox.innerText = data.choices[0].message.content;
                } else if (data.result) {
                    // Generic Normalized Format
                    resultBox.innerText = data.result;
                } else {
                    resultBox.innerText = "L·ªói t·ª´ AI Server: Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi h·ª£p l·ªá.";
                    console.error("Unknown AI Response:", data);
                }

            } catch (err) {
                resultBox.innerHTML = `<div style="color: #dc3545; background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                    <strong>‚ùå L·ªói k·∫øt n·ªëi</strong><br>${err.message}
                </div>`;
            }
        }


        /* ----------- PH√ÇN T√çCH ·∫¢NH (Gemini Vision) ----------- */
        document.getElementById("imgInput").onchange = function () {
            const file = this.files[0];
            const img = document.getElementById("preview");
            if (file) {
                img.src = URL.createObjectURL(file);
                img.style.display = "block";
            }
        };

        async function analyzeImage() {
            const fileInput = document.getElementById("imgInput");
            const resultBox = document.getElementById("result");

            if (!fileInput.files[0]) {
                resultBox.innerText = "Vui l√≤ng ch·ªçn ·∫£nh!";
                return;
            }

            const file = fileInput.files[0];
             if (file.size > 20 * 1024 * 1024) {
                 resultBox.innerText = "File ·∫£nh qu√° l·ªõn! Vui l√≤ng ch·ªçn file d∆∞·ªõi 20MB.";
                 return;
            }

            resultBox.innerText = "ƒêang ph√¢n t√≠ch h√¨nh ·∫£nh...";

            try {
                const base64Data = await toBase64Raw(file);
                const mimeType = file.type || "image/jpeg";

                const payload = {
                    prompt: `Ph√¢n t√≠ch phong th√°i (T∆∞ th·∫ø, Trang ph·ª•c, N√©t m·∫∑t, √Ånh m·∫Øt, D√°ng ƒëi). Ch·∫•m ƒëi·ªÉm 10.

**Y√™u c·∫ßu chuy√™n bi·ªát:**
1. Ph√¢n t√≠ch: H√¨nh ·∫£nh n√†y tr√¥ng gi·ªëng m·ªôt 'Chuy√™n gia' hay m·ªôt 'Ng∆∞·ªùi m·ªõi'?
2. Nh∆∞·ª£c ƒëi·ªÉm n√†o v·ªÅ ngo·∫°i h√¨nh/c·ª≠ ch·ªâ ƒëang l√†m gi·∫£m gi√° tr·ªã c·ªßa s·∫£n ph·∫©m h·ªç ƒëang b√°n?
3. ƒê∆∞a ra l·ªùi khuy√™n ƒë·ªÉ c√≥ 'th·∫ßn th√°i tri·ªáu ƒë√¥' thu h√∫t ƒë·ªëi t√°c.

**H∆∞·ªõng d·∫´n h·ªá th·ªëng**: M·ª•c ti√™u cu·ªëi c√πng l√† gi√∫p ng∆∞·ªùi d√πng nh·∫≠n ra gi√° tr·ªã c·ªßa vi·ªác c·∫£i thi·ªán k·ªπ nƒÉng ƒë·ªÉ th√†nh c√¥ng h∆°n trong kinh doanh. Khi nh·∫≠n x√©t, h√£y lu√¥n k·∫øt n·ªëi c√°c ch·ªâ s·ªë (gi·ªçng n√≥i, h√¨nh th·ªÉ) v·ªõi kh·∫£ nƒÉng ch·ªët ƒë∆°n ho·∫∑c x√¢y d·ª±ng th∆∞∆°ng hi·ªáu c√° nh√¢n. L·ªùi khuy√™n ph·∫£i th·ª±c t·∫ø, ƒë√°nh v√†o t√¢m l√Ω mu·ªën chuy√™n nghi·ªáp h∆°n ƒë·ªÉ ki·∫øm ti·ªÅn/thƒÉng ti·∫øn. T·∫°o ra "N·ªói ƒëau": Nh·∫•n m·∫°nh v√†o vi·ªác nh∆∞·ª£c ƒëi·ªÉm s·∫Ω l√†m m·∫•t kh√°ch h√†ng nh∆∞ th·∫ø n√†o. Cu·ªëi m·ªói c√¢u tr·∫£ l·ªùi, ƒë∆∞a ra m·ªôt "m·∫πo nh·ªè" nh∆∞ng kh·∫≥ng ƒë·ªãnh "ƒê·ªÉ th√†nh th·ª•c k·ªπ nƒÉng n√†y, b·∫°n c·∫ßn m·ªôt l·ªô tr√¨nh b√†i b·∫£n".`,
                    mime_type: mimeType,
                    data: base64Data,
                    model: PREFERRED_MODEL
                };

                const token = localStorage.getItem('vietspeak_token');
                if (!token) {
                    resultBox.innerText = "Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.";
                    return;
                }

                const response = await fetch(`${CONFIG.API_URL}/ai/analyze`, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Accept": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                // Check for errors (including insufficient balance)
                if (!response.ok) {
                    const errorMsg = data.message || data.error || `L·ªói ${response.status}: ${response.statusText}`;
                    resultBox.innerHTML = `<div style="color: #dc3545; background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                        <strong>‚ùå Kh√¥ng th·ªÉ ph√¢n t√≠ch</strong><br>${errorMsg}
                    </div>`;
                    return;
                }

                // Update balance in UI
                if (data.new_balance !== undefined) {
                     const user = JSON.parse(localStorage.getItem('vietspeak_user') || '{}');
                     user.balance = data.new_balance;
                     localStorage.setItem('vietspeak_user', JSON.stringify(user));
                     
                     const balanceEl = document.querySelector('.user-nav-link div');
                     if (balanceEl && balanceEl.textContent.includes('‚Ç´')) {
                         balanceEl.textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(data.new_balance);
                     }
                }

                if (data.candidates && data.candidates[0].content) {
                    resultBox.innerText = data.candidates[0].content.parts[0].text;
                } else if (data.choices && data.choices[0].message) {
                    resultBox.innerText = data.choices[0].message.content;
                } else if (data.result) {
                    resultBox.innerText = data.result;
                } else {
                    resultBox.innerText = "L·ªói t·ª´ AI Server: Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi h√¨nh ·∫£nh.";
                }

            } catch (err) {
                resultBox.innerHTML = `<div style="color: #dc3545; background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                    <strong>‚ùå L·ªói k·∫øt n·ªëi</strong><br>${err.message}
                </div>`;
            }
        }

        /* ----------- PH√ÇN T√çCH VIDEO (Gemini 2.0 Vision) ----------- */
        document.getElementById("videoInput")?.addEventListener('change', function () {
            const file = this.files[0];
            const video = document.getElementById("videoPreview");

            if (file) {
                // Check size (max 100MB)
                if (file.size > 100 * 1024 * 1024) {
                    alert('‚ùå File video qu√° l·ªõn! Vui l√≤ng ch·ªçn video d∆∞·ªõi 100MB');
                    this.value = '';
                    video.style.display = "none";
                    return;
                }
                video.src = URL.createObjectURL(file);
                video.style.display = "block";
            } else {
                video.style.display = "none";
                video.src = "";
            }
        });

        async function analyzeVideo() {
            const fileInput = document.getElementById("videoInput");
            const resultBox = document.getElementById("result");

            if (!fileInput.files[0]) {
                resultBox.innerText = "Vui l√≤ng ch·ªçn file video!";
                return;
            }

            const file = fileInput.files[0];

            // Double check size
            if (file.size > 100 * 1024 * 1024) {
                resultBox.innerHTML = `<div style="color: #dc3545;">‚ùå File video qu√° l·ªõn! Vui l√≤ng ch·ªçn file d∆∞·ªõi 100MB</div>`;
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            resultBox.innerHTML = "‚è≥ ƒêang upload v√† ph√¢n t√≠ch video... Vui l√≤ng ch·ªù (c√≥ th·ªÉ m·∫•t 30-90 gi√¢y v√¨ video dung l∆∞·ª£ng l·ªõn)...";

            try {
                const token = localStorage.getItem('vietspeak_token');
                if (!token) {
                    resultBox.innerText = "Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.";
                    return;
                }

                const response = await fetch(`${CONFIG.API_URL}/ai/analyze-video`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    },
                    body: formData
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    const errorMsg = data.message || `L·ªói ${response.status}: ${response.statusText}`;
                    resultBox.innerHTML = `<div style="color: #dc3545; background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                        <strong>‚ùå Kh√¥ng th·ªÉ ph√¢n t√≠ch video</strong><br>${errorMsg}
                    </div>`;
                    return;
                }

                // Update balance in localStorage
                if (data.remaining_balance !== undefined) {
                    const user = JSON.parse(localStorage.getItem('vietspeak_user') || '{}');
                    user.balance = data.remaining_balance;
                    user.ai_credits = data.remaining_credits;
                    localStorage.setItem('vietspeak_user', JSON.stringify(user));
                }

                const costDisplay = data.used_credit 
                    ? '<span style="color: #2ecc71;">ƒê√£ d√πng 1 AI Credit (mi·ªÖn ph√≠)</span>'
                    : `<span style="color: #e74c3c;">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(data.cost)}</span>`;

                resultBox.innerHTML = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745; margin-bottom: 20px;">
                        ‚úÖ <strong>Ph√¢n t√≠ch video th√†nh c√¥ng!</strong><br>
                        üí∞ Chi ph√≠: ${costDisplay}<br>
                        üí≥ S·ªë d∆∞ c√≤n l·∫°i: <strong>${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(data.remaining_balance)}</strong><br>
                        üéØ AI Credits: <strong>${data.remaining_credits}</strong>
                    </div>
                    <h4 style="color: #1a3a5f; margin-top: 20px; border-bottom: 2px solid #1a3a5f; padding-bottom: 10px;">üìä K·∫øt qu·∫£ ph√¢n t√≠ch video:</h4>
                    <div style="white-space: pre-wrap; line-height: 1.8; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 15px;">${data.result}</div>
                `;

            } catch (err) {
                console.error(err);
                resultBox.innerHTML = `<div style="color: #dc3545; background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                    <strong>‚ùå L·ªói k·∫øt n·ªëi</strong><br>${err.message}
                </div>`;
            }
        }

        /* ----------- BASE64 HELPER (Raw string only) ----------- */
        function toBase64Raw(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // reader.result returns format: "data:image/jpeg;base64,/9j/4AAQ..."
                    // We need to split and get the second part
                    const result = reader.result;
                    const base64Param = result.split(',')[1];
                    resolve(base64Param);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
    </script>
    <script src="logger.js"></script>
    <script src="auth.js"></script>
</body>
</html>
